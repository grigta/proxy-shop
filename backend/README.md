# Proxy Shop Backend

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Framework:** FastAPI
- **ORM:** SQLAlchemy 2.0 (async)
- **Database:** PostgreSQL
- **Migrations:** Alembic
- **Bot:** aiogram 3.x

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
backend/
‚îú‚îÄ‚îÄ api/               # API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏ dependencies
‚îÇ   ‚îî‚îÄ‚îÄ routes/        # –†–æ—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
‚îú‚îÄ‚îÄ core/              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è, database, security
‚îú‚îÄ‚îÄ models/            # SQLAlchemy –º–æ–¥–µ–ª–∏ (11 —Ç–∞–±–ª–∏—Ü)
‚îú‚îÄ‚îÄ schemas/           # Pydantic —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ services/          # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ alembic/           # Database –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ scripts/           # –£—Ç–∏–ª–∏—Ç—ã –∏ seed —Å–∫—Ä–∏–ø—Ç—ã
‚îú‚îÄ‚îÄ main.py            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îî‚îÄ‚îÄ requirements.txt   # Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã:

1. **users** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å access_code —Å–∏—Å—Ç–µ–º–æ–π
2. **user_addresses** - –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
3. **user_transactions** - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
4. **user_logs** - –ª–æ–≥–∏ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. **catalog** - –∫–∞—Ç–∞–ª–æ–≥ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (SOCKS5, PPTP)
6. **products** - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
7. **proxy_history** - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ SOCKS5
8. **pptp_history** - –∏—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫ PPTP
9. **coupons** - –∫—É–ø–æ–Ω—ã –Ω–∞ —Å–∫–∏–¥–∫—É
10. **user_coupon_activation** - –∏—Å—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫—É–ø–æ–Ω–æ–≤
11. **environment_variables** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ –ë–î

### –ö–ª—é—á–µ–≤—ã–µ –∏–Ω–¥–µ–∫—Å—ã:

- `users.access_code` (UNIQUE) - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ access_code
- `users.telegram_id` (UNIQUE) - –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ telegram_id
- `user_transactions.txid` (UNIQUE) - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è IPN
- `proxy_history.order_id` (UNIQUE) - —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–æ–≤

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
```bash
pip install -r requirements.txt
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
cp .env.example .env
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env —Ñ–∞–π–ª
```

### 3. –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö:
```bash
createdb proxy_shop
```

### 4. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
alembic upgrade head
```

### 5. Seed –¥–∞–Ω–Ω—ã–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
```bash
python scripts/init_db.py
```

## –ó–∞–ø—É—Å–∫ API —Å–µ—Ä–≤–µ—Ä–∞

### Development mode —Å hot reload:
```bash
uvicorn backend.main:app --reload --host 0.0.0.0 --port 8000
```

### –ò–ª–∏ —á–µ—Ä–µ–∑ Python:
```bash
python -m backend.main
```

### Production mode:
```bash
uvicorn backend.main:app --host 0.0.0.0 --port 8000 --workers 4
```

## Cross-Platform Authentication

–°–∏—Å—Ç–µ–º–∞ –µ–¥–∏–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ `access_code`:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –≤ –±–æ—Ç–µ –∏–ª–∏ –Ω–∞ —Å–∞–π—Ç–µ
- –ü–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `access_code` (—Ñ–æ—Ä–º–∞—Ç: `XXX-XXX-XXX`)
- –ú–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –Ω–∞ –ª—é–±–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–æ—Ç –∫–æ–¥
- `telegram_id` –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞
- –ë–∞–ª–∞–Ω—Å –∏ –∏—Å—Ç–æ—Ä–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏

## Authentication API

–°–∏—Å—Ç–µ–º–∞ JWT —Ç–æ–∫–µ–Ω–æ–≤ (access + refresh) –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É FastAPI Dependencies, –∞ –Ω–µ —á–µ—Ä–µ–∑ middleware. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- –°–µ–ª–µ–∫—Ç–∏–≤–Ω—É—é –∑–∞—â–∏—Ç—É —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –Ω—É–∂–Ω–æ)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–æ–≤
- –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞
- –õ—É—á—à—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å FastAPI –∏ –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–ó–∞—â–∏—â—ë–Ω–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å `get_current_user` –∏–∑ `backend.api.dependencies`.

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:

- `POST /api/auth/register` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `POST /api/auth/login` - –≤—Ö–æ–¥ –ø–æ access_code
- `POST /api/auth/verify` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
- `POST /api/auth/link-telegram` - –ø—Ä–∏–≤—è–∑–∫–∞ Telegram ID –∫ –∞–∫–∫–∞—É–Ω—Ç—É
- `POST /api/auth/refresh` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞

### –§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–æ–≤:
- Bearer token –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization
- Access —Ç–æ–∫–µ–Ω: 30 –º–∏–Ω—É—Ç (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)
- Refresh —Ç–æ–∫–µ–Ω: 7 –¥–Ω–µ–π (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è)

## Payment API

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å cryptocurrencyapi.net –¥–ª—è –ø—Ä–∏–µ–º–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π.

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç—ã:
- Bitcoin (BTC)
- Ethereum (ETH)
- Litecoin (LTC)
- Binance Coin (BNB)
- USDT TRC-20 (Tron)
- USDT ERC-20 (Ethereum)
- USDT BEP-20 (Binance Smart Chain)

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:

1. `POST /api/payment/generate-address` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Bearer token)
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `{"chain": "BTC"}` (–∏–ª–∏ ETH, LTC, BNB, USDT_TRC20, USDT_ERC20, USDT_BEP20)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –∞–¥—Ä–µ—Å, QR-–∫–æ–¥ (base64), –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É, —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–ª—è USDT_TRC20)

2. `POST /api/payment/webhook/ipn` - webhook –¥–ª—è IPN —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç cryptocurrencyapi.net
   - –ü—É–±–ª–∏—á–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç (–±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
   - –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ HMAC signature
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (–¥—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)

3. `GET /api/payment/history/{user_id}` - –∏—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: `?page=1&page_size=10`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –∏—Å—Ç–æ—Ä–∏—é

4. `GET /api/payment/addresses` - –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∞–¥—Ä–µ—Å–∞

### –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
10 USD (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `MIN_DEPOSIT_USD`)

### IPN Webhook:
- URL –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ `IPN_WEBHOOK_URL`)
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è signature —á–µ—Ä–µ–∑ HMAC (SHA1/SHA256/SHA512)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (type="in")
- –ú–∏–Ω–∏–º—É–º 1 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤ —Å–µ—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö IPN –≤ user_logs

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å Payment API:
- –í—Å–µ IPN webhook –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ HMAC signature
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ —á–µ—Ä–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î
- CheckConstraint –Ω–∞ balance >= 0 –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞

## API Documentation

- **Swagger UI:** http://localhost:8000/api/docs
- **ReDoc:** http://localhost:8000/api/redoc
- **OpenAPI JSON:** http://localhost:8000/api/openapi.json

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### Database:
- `DATABASE_URL` - —Å—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è PostgreSQL
- `DATABASE_ECHO` - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ (false –≤ production)

### JWT Configuration:
- `JWT_SECRET_KEY` - —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ —Ç–æ–∫–µ–Ω–æ–≤ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)
- `JWT_ALGORITHM` - –∞–ª–≥–æ—Ä–∏—Ç–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é HS256)
- `ACCESS_TOKEN_EXPIRE_MINUTES` - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ access —Ç–æ–∫–µ–Ω–∞
- `REFRESH_TOKEN_EXPIRE_DAYS` - –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ refresh —Ç–æ–∫–µ–Ω–∞

### CryptoCurrency API Configuration:
- `CRYPTO_API_KEY` - API –∫–ª—é—á –æ—Ç cryptocurrencyapi.net (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `CRYPTO_API_BASE_URL` - –±–∞–∑–æ–≤—ã–π URL API (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: https://new.cryptocurrencyapi.net/api)
- `CRYPTO_API_IPN_SECRET` - —Å–µ–∫—Ä–µ—Ç –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ IPN (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
- `CRYPTO_API_TIMEOUT` - —Ç–∞–π–º–∞—É—Ç HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 30)
- `MIN_DEPOSIT_USD` - –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10.00)
- `IPN_WEBHOOK_URL` - –ø—É–±–ª–∏—á–Ω—ã–π URL –¥–ª—è IPN webhook (–Ω–∞–ø—Ä–∏–º–µ—Ä: https://yourdomain.com/api/payment/webhook/ipn)

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è API

### –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è:
```bash
curl -X POST "http://localhost:8000/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{"platform": "web", "language": "ru"}'
```

### –í—Ö–æ–¥:
```bash
curl -X POST "http://localhost:8000/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"access_code": "ABC-DEF-GH2"}'
```

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞:
```bash
curl -X POST "http://localhost:8000/api/auth/verify" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Payment API

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è BTC –∞–¥—Ä–µ—Å–∞ –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è:
```bash
curl -X POST "http://localhost:8000/api/payment/generate-address" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"chain": "BTC"}'
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:
```bash
curl -X GET "http://localhost:8000/api/payment/history/123?page=1&page_size=10" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–¥—Ä–µ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
```bash
curl -X GET "http://localhost:8000/api/payment/addresses" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

## Troubleshooting Payment API

- –ï—Å–ª–∏ IPN –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ `IPN_WEBHOOK_URL` –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–µ–Ω
- –ï—Å–ª–∏ signature verification fails, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `CRYPTO_API_IPN_SECRET`
- –ï—Å–ª–∏ –∞–¥—Ä–µ—Å–∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å `CRYPTO_API_KEY`
- –õ–æ–≥–∏ IPN webhook –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ user_logs —Å action_type="IPN_RECEIVED"
- –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è IPN –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç—É–Ω–Ω–µ–ª—è

## User Profile & Referral API

API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –∫—É–ø–æ–Ω–∞–º–∏.

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è

1. `GET /api/user/profile` - –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (Bearer token)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –±–∞–ª–∞–Ω—Å, –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏ (–±–æ—Ç + –≤–µ–±), –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤, –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
   - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –±–æ—Ç–∞: `http://t.me/{BOT_USERNAME}?start={myreferal_id}`
   - –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è –≤–µ–±–∞: `{WEB_BASE_URL}/register?ref={myreferal_id}`

2. `GET /api/user/history` - –∏—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –§–∏–ª—å—Ç—Ä –ø–æ action_type (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: page, page_size (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 20, –º–∞–∫—Å 100)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ "DEPOSIT AMOUNT 9.932 üïû2025-10-24 21:14:01 UTC0"
   - –¢–∏–ø—ã –¥–µ–π—Å—Ç–≤–∏–π: DEPOSIT, BUY_SOCKS5, BUY_PPTP, REFUND, EXTEND_PROXY, COUPON_ACTIVATION, COUPON_APPLIED, REFERRAL_BONUS, LOGIN, REGISTER

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –∫—É–ø–æ–Ω–æ–≤

3. `POST /api/user/coupon/activate` - –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: `{"coupon_code": "DISCOUNT10"}`
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç: —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫—É–ø–æ–Ω–∞, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (is_active), —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (expires_at), –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (max_usage), one-time per user (UniqueConstraint)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: –ø—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏, –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
   - –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É–ø–æ–Ω –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä coupon_code –≤ POST /purchase/socks5 –∏–ª–∏ /purchase/pptp

### –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤

4. `GET /api/user/referrals/{user_id}` - —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –¢—Ä–µ–±—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: page, page_size
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ —Å –¥–∞—Ç–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, —Å—É–º–º–æ–π –ø–æ–∫—É–ø–æ–∫, –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º –±–æ–Ω—É—Å–æ–º
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
   - –ü—Ä–æ—Ü–µ–Ω—Ç –±–æ–Ω—É—Å–∞ –∏–∑ environment_variables (REFERRAL_BONUS_PERCENTAGE, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%)

### –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞

- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–º—É –∫–æ–¥—É: –ø–µ—Ä–µ–¥–∞—Ç—å `referral_code` –≤ POST /api/auth/register
- –§–æ—Ä–º–∞—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞: `ref_ABCDEFGH2` (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ access_code)
- –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Ä–µ—Ñ–µ—Ä–µ—Ä—É –ø—Ä–∏ **–ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ** —Ä–µ—Ñ–µ—Ä–∞–ª–∞ (–Ω–µ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- –†–∞–∑–º–µ—Ä –±–æ–Ω—É—Å–∞: –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Å—É–º–º—ã –ø–æ–∫—É–ø–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10%)
- –ë–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –±–∞–ª–∞–Ω—Å —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ user_logs —Å action_type="REFERRAL_BONUS"

### –°–∏—Å—Ç–µ–º–∞ –∫—É–ø–æ–Ω–æ–≤

- –ö—É–ø–æ–Ω –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ POST /user/coupon/activate
- –ö—É–ø–æ–Ω –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä coupon_code
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (UniqueConstraint)
- –ö—É–ø–æ–Ω –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (max_usage, NULL = –±–µ–∑–ª–∏–º–∏—Ç)
- –ö—É–ø–æ–Ω –∏–º–µ–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (expires_at, NULL = –±–µ—Å—Å—Ä–æ—á–Ω—ã–π)
- –ö—É–ø–æ–Ω –º–æ–∂–Ω–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å (is_active=False)
- –°–∫–∏–¥–∫–∞ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–∞–∫ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç —Ü–µ–Ω—ã (discount_percentage: 0-100)
- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫—É–ø–æ–Ω–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ user_logs —Å action_type="COUPON_APPLIED"

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è User Profile & Referral API

```bash
# –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
curl -X GET "http://localhost:8000/api/user/profile" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# –ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–µ–π—Å—Ç–≤–∏–π
curl -X GET "http://localhost:8000/api/user/history?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫—É–ø–æ–Ω
curl -X POST "http://localhost:8000/api/user/coupon/activate" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"coupon_code": "DISCOUNT10"}'

# –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
curl -X GET "http://localhost:8000/api/user/referrals/123?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"

# –ö—É–ø–∏—Ç—å –ø—Ä–æ–∫—Å–∏ —Å –∫—É–ø–æ–Ω–æ–º
curl -X POST "http://localhost:8000/api/purchase/socks5" \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"product_id": 123, "quantity": 1, "coupon_code": "DISCOUNT10"}'
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å User Profile & Referral API

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –∏ –∏—Å—Ç–æ—Ä–∏—é
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –≤–∏–¥–µ—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
- –ö—É–ø–æ–Ω –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ (UniqueConstraint)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –∫—É–ø–æ–Ω–∞ –ø–µ—Ä–µ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–µ–π (max_usage, expires_at, is_active)
- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
- –ê—Ç–æ–º–∞—Ä–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–æ–Ω—É—Å–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è –∞—É–¥–∏—Ç–∞
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å–∫–∏–¥–∫–∏ –∫—É–ø–æ–Ω–∞ (0-100) —á–µ—Ä–µ–∑ CheckConstraint

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [x] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Authentication API ‚úÖ
- [x] –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Payment API (cryptocurrencyapi.net) ‚úÖ
- [x] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Products & Purchase API ‚úÖ
- [x] –†–µ–∞–ª–∏–∑–∞—Ü–∏—è User Profile & Referral API ‚úÖ
- [ ] –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Telegram Bot
- [ ] –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ Web Frontend